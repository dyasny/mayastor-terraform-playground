#! /bin/sh -e

# this is a hotfix for a bug in whole-cluster tear down
# we don't need to destroy following resources as the whole cluster is going down

tfrm() {
	prefix="$1"
	shift
	while [ -n "$1" ]; do
		terraform state rm "$prefix"."$1" || true
		shift
	done
}

echo "*** Really destroy the whole infra? [y/N] "
read -r REPLY
if [ "$REPLY" != "y" ] && [ "$REPLY" != "Y" ]; then
	echo "Phew... Good think I've asked"
	exit 0
fi

tfrm module.iaas \
	kubernetes_namespace.fip_controller \
	kubernetes_namespace.minio_operator \
	null_resource.hcloud_fip_rbac_daemonset \
	null_resource.hcloud_csi \
	null_resource.calico \
	null_resource.flannel

tfrm module.paas \
	kubernetes_namespace.ingress \
	null_resource.k8s_dashboard

terraform destroy -auto-approve "$@"

rm -f "$(dirname "$0")"/../modules/iaas/secrets/*

echo "*** Check hetnzer admin, volumes are normally kept!"
